apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: myapp-stateless
  labels:
    test: ob-mirror
spec:
  mode: Pipeline
  pipeline:
  - step: patch-and-transform
    functionRef:
      name: function-patch-and-transform
    input:
      apiVersion: pt.fn.crossplane.io/v1beta1
      kind: Resources
      resources:
        - name: namespace
          base:
            apiVersion: kubernetes.crossplane.io/v1alpha2
            kind: Object
            spec:
              managementPolicies: ["Observe", "Create", "Update", "Delete"]
              forProvider:
                manifest:
                  apiVersion: v1
                  kind: Namespace
                  metadata:
                    name: ob-mirror
              providerConfigRef:
                name: vcluster-moo
          patches: []
        - name: secret
          base:
            apiVersion: kubernetes.crossplane.io/v1alpha2
            kind: Object
            spec:
              managementPolicies: ["Observe", "Create", "Update", "Delete"]
              forProvider:
                manifest:
                  apiVersion: v1
                  data:
                    AUTH_TOKEN: redacted
                  kind: Secret
                  metadata:
                    name: ob-env
                    namespace: ob-mirror
              providerConfigRef:
                name: vcluster-moo
          patches:
            - type: FromCompositeFieldPath
              fromFieldPath: "spec.envValue"
              toFieldPath: "spec.forProvider.manifest.data.AUTH_TOKEN"
        - name: deployment
          base:
            apiVersion: kubernetes.crossplane.io/v1alpha2
            kind: Object
            spec:
              managementPolicies: ["Observe", "Create", "Update", "Delete"]
              forProvider:
                manifest:
                  apiVersion: apps/v1
                  kind: Deployment
                  metadata:
                    labels:
                      app: ob-mirror
                    name: ob-mirror
                    namespace: ob-mirror
                  spec:
                    replicas: 1
                    selector:
                      matchLabels:
                        app: ob-mirror
                    template:
                      metadata:
                        labels:
                          app: ob-mirror
                      spec:
                        containers:
                        - image: ghcr.io/kingdonb/ob-mirror:canary
                          imagePullPolicy: Always
                          name: ob-mirror
                          command: ["bash"]
                          args: ["-c", "./README; sleep $((15 * 60 * 4 * 4))"]
                          envFrom:
                          - secretRef:
                              name: ob-env
              providerConfigRef:
                name: vcluster-moo
          patches:
            - type: FromCompositeFieldPath
              fromFieldPath: "spec.appImage"
              toFieldPath: "spec.forProvider.manifest.spec.template.spec.containers[0].image"
  compositeTypeRef:
    apiVersion: hephy.urmanac.com/v1alpha1
    kind: MyApp
